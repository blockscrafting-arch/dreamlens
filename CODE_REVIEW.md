# –†–µ–≤—å—é –∫–æ–¥–∞ DreamLens AI

–î–∞—Ç–∞: 2025-01-27  
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-01-27 (–ø–æ–ª–Ω–æ–µ —Ä–µ–≤—å—é)

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç SQL –≤ rateLimit.ts
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –ø—Ä—è–º–æ–π –∏–º–ø–æ—Ä—Ç –∏–∑ `@vercel/postgres`, —á—Ç–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Neon database.
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –ó–∞–º–µ–Ω–µ–Ω –Ω–∞ –∏–º–ø–æ—Ä—Ç –∏–∑ `../repositories/database.js`.

### 2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ logger
**–ü—Ä–æ–±–ª–µ–º–∞:** `logApiError` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å `new Error('Info')`.
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ `logApiInfo` –≤ 4 –º–µ—Å—Ç–∞—Ö:
- `api/repositories/database.ts` (2 –º–µ—Å—Ç–∞)
- `api/services/user.service.ts` (2 –º–µ—Å—Ç–∞)

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å CORS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ä–∞–∑—Ä–µ—à–∞–ª–∏—Å—å –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (`*`), –µ—Å–ª–∏ `ALLOWED_ORIGINS` –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ CORS –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö
- –í development —Ä–µ–∂–∏–º–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 4. –í–∞–ª–∏–¥–∞—Ü–∏—è Device ID
**–°—Ç–∞—Ç—É—Å:** –£–∂–µ –±—ã–ª–∞ —É–ª—É—á—à–µ–Ω–∞ –≤ –∫–æ–¥–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞, –¥–ª–∏–Ω—ã, –ø–∞—Ç—Ç–µ—Ä–Ω–∞)
**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** –í–∞–ª–∏–¥–∞—Ü–∏—è —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ç—Ä–æ–≥–∞—è, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

### 5. –í–∞–ª–∏–¥–∞—Ü–∏—è env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 
- –°–æ–∑–¥–∞–Ω `api/utils/env.ts` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `validateEnv()`
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `api/init-db/index.ts`
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `POSTGRES_URL` (–∏–ª–∏ `DATABASE_URL`), `GEMINI_API_KEY`
- –í—ã–¥–∞—é—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### 6. Fail-open –≤ rate limiting
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ—à–∏–±–∫–µ rate limiting —Ä–∞–∑—Ä–µ—à–∞–ª–∏—Å—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã, —á—Ç–æ –º–æ–≥–ª–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è–º.
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ: fail-closed (–∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ)
- –í development: fail-open (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è)

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ console.warn –≤–º–µ—Å—Ç–æ logger
**–§–∞–π–ª:** `api/utils/cors.ts:29`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `console.warn` –≤–º–µ—Å—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ logger
- –ù–∞—Ä—É—à–∞–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
import { logger } from './logger.js';

// –ó–∞–º–µ–Ω–∏—Ç—å console.warn –Ω–∞:
logger.warn('CORS: No allowed origins configured in production', {
  nodeEnv: process.env.NODE_ENV,
});
```

### 2. Race condition –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
**–§–∞–π–ª:** `api/services/user.service.ts:25-30, 71-76`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç race condition
- –î–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
- –•–æ—Ç—è –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ –ë–î, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `INSERT ... ON CONFLICT DO NOTHING` –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:
```typescript
// –í user.repository.ts
export async function createOrGet(userData: CreateUserData): Promise<User> {
  const result = await sql<User>`
    INSERT INTO users (clerk_id, device_id, email)
    VALUES (${userData.clerk_id || null}, ${userData.device_id || null}, ${userData.email || null})
    ON CONFLICT (clerk_id) WHERE clerk_id IS NOT NULL DO NOTHING
    ON CONFLICT (device_id) WHERE device_id IS NOT NULL DO NOTHING
    RETURNING *
  `;
  
  if (result.rows.length > 0) {
    return result.rows[0];
  }
  
  // –ï—Å–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç, –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (userData.clerk_id) {
    return await findByClerkId(userData.clerk_id) as User;
  }
  return await findByDeviceId(userData.device_id!) as User;
}
```

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ payload
**–§–∞–π–ª:** `api/generate/image.ts:50`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º–∏ (–¥–µ—Å—è—Ç–∫–∏ –ú–ë)
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—é –ø–∞–º—è—Ç–∏ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–∞–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
const MAX_PAYLOAD_SIZE = 50 * 1024 * 1024; // 50MB
const payloadSize = JSON.stringify(request.body).length;

if (payloadSize > MAX_PAYLOAD_SIZE) {
  return response.status(413).json(
    errorResponse('Payload too large. Maximum size is 50MB.', 413, undefined, requestOrigin)
  );
}

// –¢–∞–∫–∂–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
const MAX_IMAGES = 10;
if (userImages.length > MAX_IMAGES) {
  return response.status(400).json(
    errorResponse(`Too many images. Maximum ${MAX_IMAGES} images allowed.`, 400, undefined, requestOrigin)
  );
}
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `any` —Ç–∏–ø–æ–≤
**–ù–∞–π–¥–µ–Ω–æ –≤:**
- `api/generate/image.ts:40, 100, 101, 107, 144, 223` - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `any`
- `api/repositories/database.ts:36, 62` - `(values as any[])`
- `api/repositories/database.ts:105` - `(result[0] as any)`
- `api/payments/[route].ts:51, 144, 234` - `request as any`
- `api/tokens/index.ts:23, 102` - `request as any`
- `api/generations/index.ts:24, 100, 101, 118` - `request as any`
- `api/utils/geminiKeys.ts:52, 137, 162` - `error: any`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `unknown` –≤–º–µ—Å—Ç–æ `any` –≤ catch –±–ª–æ–∫–∞—Ö
- –î–æ–±–∞–≤–∏—Ç—å type guards –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤
- –°–æ–∑–¥–∞—Ç—å —Ç–∏–ø—ã –¥–ª—è VercelRequest body
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è –æ—à–∏–±–æ–∫

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```typescript
// –í–º–µ—Å—Ç–æ catch (error: any)
catch (error: unknown) {
  const errorMessage = error instanceof Error ? error.message : String(error);
  const errorCode = error && typeof error === 'object' && 'code' in error 
    ? (error as { code?: number }).code 
    : undefined;
  // ...
}

// –î–ª—è request body
interface ImageGenerationRequest {
  userImages: Array<{ base64: string; qualityScore?: number; mimeType?: string }>;
  config: {
    quality: '1K' | '2K' | '4K';
    ratio: 'PORTRAIT' | 'LANDSCAPE' | 'SQUARE';
    trend: string;
    userPrompt?: string;
    refinementText?: string;
    referenceImage?: { base64: string; mimeType?: string };
    dominantColor?: string;
  };
}
```

### 5. –°–ª–∞–±–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è webhook –ø–æ–¥–ø–∏—Å–∏
**–§–∞–π–ª:** `api/payments/[route].ts:164-174`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ signature –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω)
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å
if (process.env.NODE_ENV === 'production') {
  if (!signature || !YOOKASSA_SECRET_KEY) {
    logger.warn('Webhook signature missing in production', {
      hasSignature: !!signature,
      hasSecret: !!YOOKASSA_SECRET_KEY,
    });
    return response.status(401).json({ error: 'Signature required' });
  }
  
  // –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∏ (hex string)
  if (!/^[a-f0-9]{64}$/i.test(signature)) {
    return response.status(401).json({ error: 'Invalid signature format' });
  }
}
```

### 6. –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –≤ catch –±–ª–æ–∫–∞—Ö
**–§–∞–π–ª:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `error: any` —Å–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—à–∏–±–æ–∫ –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–≤–æ–π—Å—Ç–≤–∞–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–°–æ–∑–¥–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:
```typescript
// api/utils/errors.ts
export function getErrorMessage(error: unknown): string {
  if (error instanceof Error) {
    return error.message;
  }
  if (typeof error === 'string') {
    return error;
  }
  return 'Unknown error';
}

export function getErrorCode(error: unknown): number | undefined {
  if (error && typeof error === 'object') {
    if ('code' in error && typeof error.code === 'number') {
      return error.code;
    }
    if ('status' in error && typeof error.status === 'number') {
      return error.status;
    }
    if ('statusCode' in error && typeof error.statusCode === 'number') {
      return error.statusCode;
    }
  }
  return undefined;
}
```

### 7. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
**–§–∞–π–ª:** `api/payments/[route].ts:130-133`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
const existingPayment = await sql`
  SELECT id FROM payments WHERE yookassa_payment_id = ${payment.id} LIMIT 1
`;

if (existingPayment.rows.length > 0) {
  logger.warn('Duplicate payment attempt', {
    paymentId: payment.id,
    userId: user.id.substring(0, 8) + '...',
  });
  // –í–µ—Ä–Ω—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂
  const existing = await sql`
    SELECT * FROM payments WHERE yookassa_payment_id = ${payment.id} LIMIT 1
  `;
  return response.status(200).json(
    successResponse({
      paymentId: existing.rows[0].yookassa_payment_id,
      status: existing.rows[0].status,
      duplicate: true,
    })
  );
}
```

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### 8. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –ö–∞–∂–¥—ã–π endpoint –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø–æ-—Å–≤–æ–µ–º—É
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:
```typescript
export function withErrorHandler(
  handler: (req: VercelRequest, res: VercelResponse) => Promise<Response>
) {
  return async (req: VercelRequest, res: VercelResponse) => {
    try {
      return await handler(req, res);
    } catch (error) {
      return errorResponse('Internal server error', 500, undefined, req.headers.origin);
    }
  };
}
```

### 9. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–∞ –ø–æ –∫–æ–¥—É
- –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `zod`):
```typescript
import { z } from 'zod';

const ImageConfigSchema = z.object({
  quality: z.enum(['1K', '2K', '4K']),
  ratio: z.enum(['PORTRAIT', 'LANDSCAPE', 'SQUARE']),
  trend: z.string().min(1).max(50),
  // ...
});
```

### 10. –¢–∏–ø–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ API
**–ü—Ä–æ–±–ª–µ–º–∞:**
- `ApiResponse<T>` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–£–ª—É—á—à–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é:
```typescript
export interface ApiResponse<T = unknown> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
  code?: string;
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å discriminated union
export type SuccessResponse<T> = { success: true; data: T; message?: string };
export type ErrorResponse = { success: false; error: string; message?: string; code?: string };
export type ApiResponse<T> = SuccessResponse<T> | ErrorResponse;
```

### 11. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í –ª–æ–≥–∞—Ö –º–æ–≥—É—Ç –ø–æ–ø–∞–¥–∞—Ç—å —Ç–æ–∫–µ–Ω—ã, –∫–ª—é—á–∏ API (—á–∞—Å—Ç–∏—á–Ω–æ –º–∞—Å–∫–∏—Ä—É—é—Ç—Å—è)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∞—Å–∫–∏—Ä—É—é—Ç—Å—è
- –ù–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã, –¥–∞–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ

### 12. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –ï—Å—Ç—å —Ç–µ—Å—Ç—ã, –Ω–æ –ø–æ–∫—Ä—ã—Ç–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è API endpoints
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:
‚úÖ –•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ repositories, services, utils)
‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TypeScript —Å strict mode
‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –º–µ—Å—Ç
‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –ë–î (CTE –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
‚úÖ Rate limiting —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ fallback –¥–ª—è Gemini API –∫–ª—é—á–µ–π

### –û–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:
‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (CORS, –≤–∞–ª–∏–¥–∞—Ü–∏—è)
‚ö†Ô∏è –¢–∏–ø–∏–∑–∞—Ü–∏—è (–º–µ–Ω—å—à–µ `any`)
‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è)
‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚ö†Ô∏è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç SQL –≤ rateLimit.ts (–ò–°–ü–†–ê–í–õ–ï–ù–û)
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ logger (–ò–°–ü–†–ê–í–õ–ï–ù–û)
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å CORS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
4. ‚úÖ –£–ª—É—á—à–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é Device ID (–£–ñ–ï –ë–´–õ–û –£–õ–£–ß–®–ï–ù–û)
5. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–ò–°–ü–†–ê–í–õ–ï–ù–û)
6. ‚úÖ –£–ª—É—á—à–∏—Ç—å fail-open –≤ rate limiting (–ò–°–ü–†–ê–í–õ–ï–ù–û)

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
1. –ó–∞–º–µ–Ω–∏—Ç—å `console.warn` –Ω–∞ logger –≤ cors.ts
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞ payload
4. –£–ª—É—á—à–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é (—É–±—Ä–∞—Ç—å `any`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `unknown`)
5. –£—Å–∏–ª–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é webhook –ø–æ–¥–ø–∏—Å–∏
6. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
7. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (zod)
8. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
10. –£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
11. –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
12. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ö–æ–¥ –≤ —Ü–µ–ª–æ–º —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–ª–µ–¥—É–µ—Ç –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–≤—è–∑–∞–Ω—ã —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –∫–æ–¥ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É.

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 7.5/10
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 8/10 ‚úÖ
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 6/10 ‚ö†Ô∏è (—É–ª—É—á—à–µ–Ω–∞, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã)
- –¢–∏–ø–∏–∑–∞—Ü–∏—è: 6/10 ‚ö†Ô∏è (–º–Ω–æ–≥–æ `any`, –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: 6/10 ‚ö†Ô∏è (–Ω—É–∂–Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è)
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 6/10 ‚ö†Ô∏è (–Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø–æ–∫—Ä—ã—Ç–∏—è)
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 7/10 ‚úÖ (—Ö–æ—Ä–æ—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Å CTE, –Ω–æ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ payload)

## üìã –ù–æ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ (2025-01-27)

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `console.warn` –≤–º–µ—Å—Ç–æ logger - **–°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢**
2. ‚ö†Ô∏è Race condition –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**
3. ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ payload - **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**
4. ‚ö†Ô∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `any` —Ç–∏–ø–æ–≤ - **–í–ê–ñ–ù–´–ô**
5. ‚ö†Ô∏è –°–ª–∞–±–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è webhook –ø–æ–¥–ø–∏—Å–∏ - **–í–ê–ñ–ù–´–ô**
6. ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π - **–í–ê–ñ–ù–´–ô**

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:
‚úÖ SQL-–∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—é (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π)
‚úÖ –•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏ (repositories, services, utils)
‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –ë–î (CTE –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫—Ä–æ–º–µ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞)
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è Device ID —É–ª—É—á—à–µ–Ω–∞
‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
‚úÖ Rate limiting —Å fail-closed –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

