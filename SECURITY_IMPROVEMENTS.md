# –£–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. CORS –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
**–§–∞–π–ª:** `api/utils/cors.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `ALLOWED_ORIGINS` –≤—Å–µ CORS –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –í development —Ä–µ–∂–∏–º–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```bash
# –í Vercel Dashboard ‚Üí Environment Variables
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

### 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
**–§–∞–π–ª:** `api/utils/env.ts` (–Ω–æ–≤—ã–π)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
- –í—ã–¥–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç fallback –¥–ª—è `POSTGRES_URL` ‚Üí `DATABASE_URL`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
import { validateEnv } from '../utils/env.js';

// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ api/init-db
// –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö endpoints –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
validateEnv();
```

### 3. Rate Limiting - Fail-closed –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
**–§–∞–π–ª:** `api/utils/rateLimit.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ: –ø—Ä–∏ –æ—à–∏–±–∫–µ rate limiting –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è (fail-closed)
- –í development: –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑—Ä–µ—à–∞—é—Ç—Å—è (fail-open –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- Production: –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ - –æ—Ç–∫–ª–æ–Ω—è–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- Development: —É–¥–æ–±—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### 4. –í–∞–ª–∏–¥–∞—Ü–∏—è Device ID
**–°—Ç–∞—Ç—É—Å:** –£–∂–µ –±—ã–ª–∞ —É–ª—É—á—à–µ–Ω–∞ —Ä–∞–Ω–µ–µ

**–¢–µ–∫—É—â–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–∞ `device_`
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ 20 —Å–∏–º–≤–æ–ª–æ–≤
- –ü–∞—Ç—Ç–µ—Ä–Ω: —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
- –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

## üìã –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

–ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º —É–±–µ–¥–∏—Ç–µ—Å—å:

- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω `ALLOWED_ORIGINS` –≤ Vercel Environment Variables
- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
  - [ ] `POSTGRES_URL` –∏–ª–∏ `DATABASE_URL`
  - [ ] `GEMINI_API_KEY`
- [ ] –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
  - [ ] `CLERK_SECRET_KEY` (–¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
  - [ ] `GEMINI_API_KEY_BACKUP` (–¥–ª—è fallback)
  - [ ] `DB_INIT_SECRET` (–¥–ª—è –∑–∞—â–∏—Ç—ã init-db endpoint)

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS:**
   ```bash
   curl -H "Origin: https://yourdomain.com" \
        -H "Access-Control-Request-Method: POST" \
        -X OPTIONS \
        https://your-api.vercel.app/api/generate/image
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é env:**
   ```bash
   # –í—ã–∑–æ–≤–∏—Ç–µ init-db endpoint (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω DB_INIT_SECRET)
   curl https://your-api.vercel.app/api/init-db?secret=YOUR_SECRET
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ CORS
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏ rate limiting
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ CORS –∑–∞–ø—Ä–æ—Å—ã

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ rate limiting –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É CORS —Å —Ä–∞–∑–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤

3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
   - –û–±–Ω–æ–≤–∏—Ç–µ README —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–æ–≤—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö
   - –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- **CORS:** –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –±–µ–∑ `ALLOWED_ORIGINS` –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –æ—Ç–∫–ª–æ–Ω—è—Ç—å—Å—è
- **Rate Limiting:** –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ë–î –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
- **Env Validation:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `init-db`, –¥–ª—è –¥—Ä—É–≥–∏—Ö endpoints –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `api/utils/cors.ts` - CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `api/utils/env.ts` - –í–∞–ª–∏–¥–∞—Ü–∏—è env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- `api/utils/rateLimit.ts` - Rate limiting
- `api/utils/auth.ts` - –í–∞–ª–∏–¥–∞—Ü–∏—è Device ID (—É–∂–µ –±—ã–ª–∞ —É–ª—É—á—à–µ–Ω–∞)
- `api/init-db/index.ts` - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é env

